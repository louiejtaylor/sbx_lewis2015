---
title: "Lewis *et al* 2015: Crohn's disease clusters"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = "hide",
                      dev = "svg")
library(dplyr)
library(magrittr)
library(ggplot2)
library(viridis)
library(stringr)
library(vegan)
library(MASS)

taxa_ranks <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

theme_scatterplot = theme_classic(base_size = 16) + theme(
  line = element_line(size=0.8),
  text = element_text(color = "black"),
  axis.text.x = element_text(color="black"),
  axis.text.y = element_text(color="black")
)

# Make sure Snakemake handles accessible
stopifnot(exists("snakemake"))
```

## Background

This report uses the [Sunbeam pipeline](https://github.com/sunbeam-labs/sunbeam) to reproduce findings from the 2015 Lewis *et al.* paper entitled "Inflammation, Antibiotics, and Diet as Environmental Stressors of the Gut Microbiome in Pediatric Crohn's Disease" [(PMID: 26468751)](https://www.ncbi.nlm.nih.gov/pubmed/26468751). A key finding of this paper was that individuals with Crohn's disease form two distinct clusters by Multidimensional Scaling (MDS)--the dysbiotic cluster tended to have a high human DNA fraction. Here, we test whether we can reproduce this finding using the originial data submitted to the SRA, and compare three different read-based classification methods available in Sunbeam or as Sunbeam extensions: Kaiju, Kraken, and MetaPhlAn2.


This report was generated by the extension [sbx_lewis2015](https://github.com/louiejtaylor/sbx_lewis2015); this link also includes instructions for re-running this analysis from the beginning. It depends on output from two other extensions: [sbx_kaiju](https://github.com/sunbeam-labs/sbx_kaiju) and [sbx_metaphlan](https://github.com/sunbeam-labs/sbx_metaphlan/), make sure they are installed before running this analysis.

```{r paths}

metadata_file <- file.path(snakemake@params[['metadata_file']])
kraken_file <- file.path(snakemake@input[['kraken']])
kaiju_file <- file.path(snakemake@input[['kaiju']])
metaphlan_file <- file.path(snakemake@input[['metaphlan']])

```

```{r metadata-and-classification}
md = read.table(metadata_file, sep = ",", header = TRUE)

md_0 <- dplyr::filter(md, Type == "PLEASE-T1" | Type == "COMBO") %>%
  dplyr::filter(!is.na(Cluster))

kraken <- read.table(kraken_file, header = TRUE, skip = 1, sep = '\t', comment.char = '~')
kaiju = read.table(kaiju_file, header = TRUE, skip = 1, sep = '\t', comment.char = '~', quote = "~")
metaphlan <- read.table(metaphlan_file, header = TRUE, sep = '\t', comment.char = '~', quote = "~")

```
## Results

Below are Nonmetric Multidimensional Scaling plots generated using the `vegan` package in R. Each point is colored by the cluster in which it was annotated in the Lewis *et al* metadata, to query whether our results match those published previously. Cluster 2 (red) is the dysbiotic cluster, while cluster 1 (blue) is the healthy-like cluster. Lewis *et al* used MetaPhlAn to classify reads in the original analysis.

### Kraken results
```{r kraken-plots}
kraken_otus <- kraken$X.OTU.ID

test_kraken <- kraken %$%
  dplyr::select(., -c("Consensus.Lineage")) %$%
  as.data.frame(t(.[,-1]))

colnames(test_kraken) <- kraken_otus
vare.dist <- vegdist(test_kraken)
vare.mds0 <- vegan::metaMDS(vare.dist)

as.data.frame(vare.mds0[["points"]]) %$% 
  dplyr::mutate(., Run = gsub(".taxa", "", row.names(.), fixed = TRUE)) %$%
  inner_join(., md_0, by = "Run") %>%
  ggplot(aes(x = MDS1, y = MDS2, shape = Group, color = Cluster, size = Human.Per))+
  geom_point() + 
  scale_shape_manual(values = c(20,21)) +
  scale_color_manual(values = c("blue", "red")) +
  labs(size="Percent Human\nReads")+
  theme_scatterplot

```

### Kaiju results
```{r kaiju-plots}

kaiju_otus <- kaiju$X.OTU.ID

test_kaiju <- kaiju %$%
  dplyr::select(., -c("Consensus.Lineage")) %$%
  as.data.frame(t(.[,-1]))

colnames(test_kaiju) <- kaiju_otus
vare.dist <- vegdist(test_kaiju)
vare.mds0 <- vegan::metaMDS(vare.dist)

as.data.frame(vare.mds0[["points"]]) %$% 
  dplyr::mutate(., Run = gsub(".taxa", "", row.names(.), fixed = TRUE)) %$%
  inner_join(., md_0, by = "Run") %>%
  ggplot(aes(x = MDS1, y = MDS2, shape = Group, color = Cluster, size = Human.Per))+
  geom_point() + 
  scale_shape_manual(values = c(20,21)) +
  scale_color_manual(values = c("blue", "red")) +
  labs(size="Percent Human\nReads")+
  theme_scatterplot

```


### MetaPhlAn2 results

For these, a few samples came out of MetaPhlAn with 100% unclassified--they are omitted from this plot.

```{r metaphlan-plots}

metaphlan_otus <- metaphlan$Term

test_metaphlan <- metaphlan %$%
  as.data.frame(t(.[,-1]))

colnames(test_metaphlan) <- metaphlan_otus

test_metaphlan <- tibble::rownames_to_column(test_metaphlan, "rows") %>%
  dplyr::filter(unclassified < 100) %>%
  tibble::column_to_rownames("rows")

vare.dist <- vegdist(test_metaphlan)
vare.mds0 <- vegan::metaMDS(vare.dist)

as.data.frame(vare.mds0[["points"]]) %$% 
  dplyr::mutate(., Run = gsub("_review", "", row.names(.), fixed = TRUE)) %$%
  inner_join(., md_0, by = "Run") %>%
  ggplot(aes(x = MDS1, y = MDS2, shape = Group, color = Cluster, size = Human.Per))+
  geom_point() + 
  scale_shape_manual(values = c(20,21)) +
  scale_color_manual(values = c("blue", "red")) +
  labs(size="Percent Human\nReads")+
  theme_scatterplot

```

## Conclusion

All three classification methods support the conclusions of the original paper.
