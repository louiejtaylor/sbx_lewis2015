---
title: "Crohn's disease clusters"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = "hide",
                      dev = "svg")
library(dplyr)
library(magrittr)
library(ggplot2)
library(viridis)
library(stringr)
library(vegan)
library(MASS)

taxa_ranks <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

theme_scatterplot = theme_classic(base_size = 14) + theme(
  line = element_line(size=0.8),
  text = element_text(color = "black"),
  axis.text.x = element_text(color="black"),
  axis.text.y = element_text(color="black")
)
```

## Background

This report visualizes Sunbeam outputs to reproduce findings from the 2015 Lewis *et al.* paper entitled "Inflammation, Antibiotics, and Diet as Environmental Stressors of the Gut Microbiome in Pediatric Crohn's Disease" [(PMID: 26468751)](https://www.ncbi.nlm.nih.gov/pubmed/26468751). It compares three methods of read-based classification: Kaiju, Kraken, and MetaPhlAn2.

This report was generated by the extension [sbx_lewis2015](https://github.com/sunbeam-labs/sbx_lewis2015), this link also includes instructions for re-running this analysis. It depends on output from two other extensions: [sbx_kaiju](https://github.com/sunbeam-labs/sbx_kaiju) and [sbx_metaphlan](https://github.com/sunbeam-labs/sbx_metaphlan/).

```{r metadata}
md = read.table("/home/louistaylor/THING2/17_SunbeamPaper/01_Reproducing/00_Reports/sbx_lewis2015/metadata/metadata_with_SRR.csv", sep = ",", header = TRUE)

md_0 <- dplyr::filter(md, Type == "PLEASE-T1" | Type == "COMBO") %>%
  dplyr::filter(!is.na(Cluster))

```


```{r read-classifications}
kraken <- read.table('/home/louistaylor/THING2/17_SunbeamPaper/01_Reproducing/01_Lewis2015PLEASE/sunbeam_output/classify/kraken/all_samples.tsv', header = TRUE, skip = 1, sep = '\t', comment.char = '~')

# Generate like:
# biom convert -i all_samples.biom -o all_samples.tsv --to-tsv --header-key taxonomy --process-obs-metadata=taxonomy --output-metadata-id="Consensus Lineage"

kaiju = read.table('/home/louistaylor/THING2/17_SunbeamPaper/01_Reproducing/01_Lewis2015PLEASE/sunbeam_output/classify/kaiju/all_samples.tsv', header = TRUE, skip = 1, sep = '\t', comment.char = '~', quote = "~")

#kaiju_parsed <- ParseOTUTable('/home/louistaylor/THING2/17_SunbeamPaper/01_Reproducing/01_Lewis2015PLEASE/sunbeam_output/classify/kaiju/all_samples.tsv') 

metaphlan <- read.table('/home/louistaylor/THING2/17_SunbeamPaper/01_Reproducing/01_Lewis2015PLEASE/sunbeam_output/classify/metaphlan/taxonomic_assignments.tsv', header = TRUE, sep = '\t', comment.char = '~', quote = "~")

#metaphlan_parsed <- ParseMetaphlanOTUTable('/home/louistaylor/THING2/17_SunbeamPaper/01_Reproducing/01_Lewis2015PLEASE/sunbeam_output/classify/metaphlan/taxonomic_assignments.tsv')
```


## Kraken results
```{r kraken-plots}
kraken_otus <- kraken$X.OTU.ID

test_kraken <- kraken %$%
  dplyr::select(., -c("Consensus.Lineage")) %$%
  as.data.frame(t(.[,-1]))

colnames(test_kraken) <- kraken_otus
vare.dist <- vegdist(test_kraken)
vare.mds0 <- vegan::metaMDS(vare.dist)
#ordiplot(vare.mds0, type = "p")

as.data.frame(vare.mds0[["points"]]) %$% 
  dplyr::mutate(., Run = gsub(".taxa", "", row.names(.), fixed = TRUE)) %$%
  inner_join(., md_0, by = "Run") %>%
  ggplot(aes(x = MDS1, y = MDS2, shape = Group, color = Cluster, size = Human.Per))+
  geom_point() + 
  scale_shape_manual(values = c(20,21)) +
  scale_color_manual(values = c("blue", "red")) +
  theme_scatterplot

```

## Kaiju results
```{r kaiju-plots}

kaiju_otus <- kaiju$X.OTU.ID

test_kaiju <- kaiju %$%
  dplyr::select(., -c("Consensus.Lineage")) %$%
  as.data.frame(t(.[,-1]))

colnames(test_kaiju) <- kaiju_otus
vare.dist <- vegdist(test_kaiju)
vare.mds0 <- vegan::metaMDS(vare.dist)
#ordiplot(vare.mds0, type = "p")

as.data.frame(vare.mds0[["points"]]) %$% 
  dplyr::mutate(., Run = gsub(".taxa", "", row.names(.), fixed = TRUE)) %$%
  inner_join(., md_0, by = "Run") %>%
  ggplot(aes(x = MDS1, y = MDS2, shape = Group, color = Cluster, size = Human.Per))+
  geom_point() + 
  scale_shape_manual(values = c(20,21)) +
  scale_color_manual(values = c("blue", "red")) +
  theme_scatterplot

```


## MetaPhlAn2 results

For these, a few samples came out of MetaPhlAn with 100% unclassified. As I'm not sure why it happened, I've omitted them from this plot.

```{r metaphlan-plots}

metaphlan_otus <- metaphlan$Term

test_metaphlan <- metaphlan %$%
#  dplyr::select(., -c("Term")) %$%
  as.data.frame(t(.[,-1]))

colnames(test_metaphlan) <- metaphlan_otus

test_metaphlan <- tibble::rownames_to_column(test_metaphlan, "rows") %>%
  dplyr::filter(unclassified < 100) %>%
  tibble::column_to_rownames("rows")

vare.dist <- vegdist(test_metaphlan)
vare.mds0 <- vegan::metaMDS(vare.dist)

as.data.frame(vare.mds0[["points"]]) %$% 
  dplyr::mutate(., Run = gsub("_review", "", row.names(.), fixed = TRUE)) %$%
  inner_join(., md_0, by = "Run") %>%
  ggplot(aes(x = MDS1, y = MDS2, shape = Group, color = Cluster, size = Human.Per))+
  geom_point() + 
  scale_shape_manual(values = c(20,21)) +
  scale_color_manual(values = c("blue", "red")) +
  theme_scatterplot

```
